<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Agent Terminal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 1.5rem; background: #0b1120; color: #e5e7eb; }
      .card { background: #111827; padding: 1rem; border-radius: 12px; box-shadow: 0 6px 28px rgba(0,0,0,.4); max-width: 1200px; margin: 0 auto; }
      .title { display:flex; justify-content: space-between; align-items:center; }
      a { color: #93c5fd; }
      .terminal-wrap { height: 70vh; background: #000; border-radius: 8px; border: 1px solid #374151; overflow: hidden; }
      #terminal { height: 100%; width: 100%; }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="title">
        <h3>Agent Terminal</h3>
        <div><a href="/">‚Üê Back</a></div>
      </div>
      <div id="data" data-agent="{{ agent_id }}"></div>
      <div class="terminal-wrap"><div id="terminal"></div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script>
      const agentId = document.getElementById('data').getAttribute('data-agent');
      const term = new Terminal({ cursorBlink: true, convertEol: true, fontSize: 14 });
      const fitAddon = new FitAddon.FitAddon();
      term.loadAddon(fitAddon);
      term.open(document.getElementById('terminal'));
      fitAddon.fit();

      function sendResize(ws) {
        ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
      }

      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(proto + '://' + location.host + '/ws/terminal/' + encodeURIComponent(agentId));
      ws.addEventListener('open', () => { term.focus(); sendResize(ws); });
      ws.addEventListener('message', ev => term.write(ev.data));
      ws.addEventListener('close', () => term.write('\r\n\x1b[31m[Disconnected]\x1b[0m\r\n'));
      ws.addEventListener('error', () => term.write('\r\n\x1b[31m[Error]\x1b[0m\r\n'));
      term.onData(d => { if (ws.readyState === WebSocket.OPEN) ws.send(d); });
      window.addEventListener('resize', () => { fitAddon.fit(); if (ws.readyState === WebSocket.OPEN) sendResize(ws); });
    </script>
  </body>
  </html>


